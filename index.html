<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coral Bleaching Predictor</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a nice font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for slider thumb and track */
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            background: #3b82f6; /* blue-500 */
            border-radius: 50%;
            cursor: pointer;
            margin-top: -6px;
        }
        input[type=range]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            background: #3b82f6;
            border-radius: 50%;
            cursor: pointer;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <!-- Login Section -->
    <div id="login-section" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-8 space-y-6">
            <div class="text-center">
                <h1 class="text-3xl font-bold text-gray-800">Coral Bleaching Predictor</h1>
                <p class="text-gray-500 mt-2">Please login to access the prediction tool</p>
            </div>

            <form id="login-form" class="space-y-4">
                <div>
                    <label for="username" class="block text-sm font-medium text-gray-700">Username</label>
                    <input type="text" id="username" name="username" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label for="password" class="block text-sm font-medium text-gray-700">Password</label>
                    <input type="password" id="password" name="password" required 
                           class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                </div>
                <button type="submit" 
                        class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition duration-300">
                    Login
                </button>
            </form>

            <div id="login-error" class="hidden p-4 bg-red-100 text-red-700 rounded-lg">
                <p><strong>Login Error:</strong> <span id="login-error-text"></span></p>
            </div>

            <div class="text-center text-sm text-gray-500">
                <p>Demo Credentials:</p>
                <p>Username: <strong>johndoe</strong></p>
                <p>Password: <strong>secretpassword</strong></p>
            </div>
        </div>
    </div>

    <!-- Main Application Section -->
    <div id="app-section" class="hidden">
        <!-- Header with Logout -->
        <div class="bg-white shadow-sm border-b">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <h1 class="text-2xl font-bold text-gray-800">Marine Ecosystem Health Predictor</h1>
                    <div class="flex items-center space-x-4">
                        <span id="user-info" class="text-gray-600"></span>
                        <button id="logout-btn" 
                                class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition duration-300">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="max-w-2xl mx-auto py-8 px-4">
            <div class="bg-white rounded-xl shadow-lg p-8 space-y-6">
                <!-- Header Section -->
                <div class="text-center">
                    <h2 class="text-2xl font-bold text-gray-800">Coral Bleaching Prediction</h2>
                    <p class="text-gray-500 mt-2">Adjust the environmental factors below to predict the likelihood of a coral bleaching event.</p>
                </div>

                <!-- Input Form with Sliders -->
                <form id="prediction-form" class="space-y-8">
                    <!-- Single Slider Input -->
                    <div class="slider-group">
                        <label for="Turbidity" class="flex justify-between items-center text-lg font-medium text-gray-700">
                            <span>Turbidity</span>
                            <span id="Turbidity-value" class="font-bold text-blue-600">0.5</span>
                        </label>
                        <input type="range" id="Turbidity" name="Turbidity" min="0" max="5" step="0.1" value="0.5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <div class="slider-group">
                        <label for="Depth_m" class="flex justify-between items-center text-lg font-medium text-gray-700">
                            <span>Depth (meters)</span>
                            <span id="Depth_m-value" class="font-bold text-blue-600">10</span>
                        </label>
                        <input type="range" id="Depth_m" name="Depth_m" min="0" max="50" step="1" value="10" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <div class="slider-group">
                        <label for="Temperature_Maximum" class="flex justify-between items-center text-lg font-medium text-gray-700">
                            <span>Max Temperature (Â°C)</span>
                            <span id="Temperature_Maximum-value" class="font-bold text-blue-600">30.0</span>
                        </label>
                        <input type="range" id="Temperature_Maximum" name="Temperature_Maximum" min="20" max="40" step="0.1" value="30.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <div class="slider-group">
                        <label for="SSTA_DHW" class="flex justify-between items-center text-lg font-medium text-gray-700">
                            <span>Degree Heating Week (SSTA)</span>
                            <span id="SSTA_DHW-value" class="font-bold text-blue-600">4.0</span>
                        </label>
                        <input type="range" id="SSTA_DHW" name="SSTA_DHW" min="0" max="20" step="0.1" value="4.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <div class="slider-group">
                        <label for="TSA_DHW" class="flex justify-between items-center text-lg font-medium text-gray-700">
                            <span>Degree Heating Week (TSA)</span>
                            <span id="TSA_DHW-value" class="font-bold text-blue-600">1.0</span>
                        </label>
                        <input type="range" id="TSA_DHW" name="TSA_DHW" min="0" max="20" step="0.1" value="1.0" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Submit Button -->
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg hover:bg-blue-700 transition duration-300 text-lg">
                        Predict
                    </button>
                </form>

                <!-- Result Display Area -->
                <div id="result-container" class="text-center pt-4 hidden">
                     <div id="result-card" class="p-6 rounded-lg">
                        <h2 id="result-text" class="text-2xl font-bold"></h2>
                        <p id="result-advice" class="mt-2"></p>
                    </div>
                </div>
                 <!-- Error Display Area -->
                <div id="error-container" class="text-center pt-4 hidden">
                    <div class="p-4 bg-red-100 text-red-700 rounded-lg">
                        <p><strong>Error:</strong> <span id="error-text"></span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let authToken = null;
        let currentUser = null;

        // DOM elements
        const loginSection = document.getElementById('login-section');
        const appSection = document.getElementById('app-section');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const loginErrorText = document.getElementById('login-error-text');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const form = document.getElementById('prediction-form');
        const resultContainer = document.getElementById('result-container');
        const resultCard = document.getElementById('result-card');
        const resultText = document.getElementById('result-text');
        const resultAdvice = document.getElementById('result-advice');
        const errorContainer = document.getElementById('error-container');
        const errorText = document.getElementById('error-text');

        // Check if user is already logged in
        function checkAuth() {
            const token = localStorage.getItem('authToken');
            const user = localStorage.getItem('currentUser');
            if (token && user) {
                authToken = token;
                currentUser = JSON.parse(user);
                showApp();
            }
        }

        // Show login section
        function showLogin() {
            loginSection.classList.remove('hidden');
            appSection.classList.add('hidden');
        }

        // Show app section
        function showApp() {
            loginSection.classList.add('hidden');
            appSection.classList.remove('hidden');
            userInfo.textContent = `Welcome, ${currentUser.username}!`;
        }

        // Handle login form submission
        loginForm.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            const formData = new FormData(loginForm);
            const username = formData.get('username');
            const password = formData.get('password');

            try {
                const response = await fetch('http://127.0.0.1:8000/token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}`
                });

                if (response.ok) {
                    const data = await response.json();
                    authToken = data.access_token;
                    currentUser = { username: username };
                    
                    // Store in localStorage
                    localStorage.setItem('authToken', authToken);
                    localStorage.setItem('currentUser', JSON.stringify(currentUser));
                    
                    showApp();
                    loginError.classList.add('hidden');
                } else {
                    const errorData = await response.json();
                    loginErrorText.textContent = errorData.detail || 'Login failed';
                    loginError.classList.remove('hidden');
                }
            } catch (error) {
                console.error('Login error:', error);
                loginErrorText.textContent = 'Could not connect to server';
                loginError.classList.remove('hidden');
            }
        });

        // Handle logout
        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('authToken');
            localStorage.removeItem('currentUser');
            authToken = null;
            currentUser = null;
            showLogin();
        });

        // Update slider value display in real-time
        const sliders = document.querySelectorAll('input[type=range]');
        sliders.forEach(slider => {
            const valueDisplay = document.getElementById(`${slider.id}-value`);
            slider.addEventListener('input', () => {
                valueDisplay.textContent = slider.value;
            });
        });

        // Handle prediction form submission
        form.addEventListener('submit', async (event) => {
            event.preventDefault();
            
            // Hide previous results and errors
            resultContainer.classList.add('hidden');
            errorContainer.classList.add('hidden');

            // Check if user is authenticated
            if (!authToken) {
                errorText.textContent = 'Please login first';
                errorContainer.classList.remove('hidden');
                return;
            }

            // Collect data from the form
            const formData = new FormData(form);
            const data = {
                Turbidity: parseFloat(formData.get('Turbidity')),
                Depth_m: parseFloat(formData.get('Depth_m')),
                Temperature_Maximum: parseFloat(formData.get('Temperature_Maximum')),
                SSTA_DHW: parseFloat(formData.get('SSTA_DHW')),
                TSA_DHW: parseFloat(formData.get('TSA_DHW'))
            };

            // Send data to the FastAPI backend
            try {
                const response = await fetch('http://127.0.0.1:8000/predict', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${authToken}`
                    },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const result = await response.json();
                    displayResult(result.prediction);
                } else if (response.status === 401) {
                    // Token expired or invalid
                    localStorage.removeItem('authToken');
                    localStorage.removeItem('currentUser');
                    authToken = null;
                    currentUser = null;
                    errorText.textContent = 'Session expired. Please login again.';
                    errorContainer.classList.remove('hidden');
                    setTimeout(() => showLogin(), 2000);
                } else {
                    const errorData = await response.json();
                    errorText.textContent = errorData.detail || 'Prediction failed';
                    errorContainer.classList.remove('hidden');
                }

            } catch (error) {
                console.error('Fetch error:', error);
                errorText.textContent = 'Could not connect to the API. Please ensure the backend server is running.';
                errorContainer.classList.remove('hidden');
            }
        });

        // Function to display the prediction result
        function displayResult(prediction) {
            resultContainer.classList.remove('hidden');
            if (prediction === 1) {
                resultCard.className = 'p-6 rounded-lg bg-red-100 text-red-800';
                resultText.textContent = 'High Risk of Bleaching Event';
                resultAdvice.textContent = 'The environmental conditions are highly conducive to coral bleaching. Mitigation efforts may be required.';
            } else {
                resultCard.className = 'p-6 rounded-lg bg-green-100 text-green-800';
                resultText.textContent = 'Low Risk of Bleaching Event';
                resultAdvice.textContent = 'The environmental conditions appear stable and are not indicative of an immediate bleaching threat.';
            }
        }

        // Initialize the app
        checkAuth();
    </script>

</body>
</html>
