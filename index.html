<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coral Bleaching Predictor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.plot.ly/plotly-2.32.0.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc; /* slate-50 */
            background-image: radial-gradient(#d1d5db 0.5px, transparent 0.5px);
            background-size: 15px 15px;
            margin: 0;
            padding: 0;
        }

        /* Smooth Transitions */
        .smooth-transition {
            transition: opacity 0.5s ease-in-out, transform 0.5s ease-in-out;
        }
        
        /* Fix for section visibility */
        .section-hidden {
            opacity: 0;
            transform: scale(0.95);
            pointer-events: none;
            display: none;
        }
        
        .section-visible {
            opacity: 1;
            transform: scale(1);
            display: block;
        }

        /* Custom Slider Styles */
        input[type=range] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 9999px;
            outline: none;
            --value-percent: 50%; /* Default value */
            background: linear-gradient(to right, #22d3ee 0%, #22d3ee var(--value-percent), #e5e7eb var(--value-percent), #e5e7eb 100%);
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #ffffff;
            border: 2px solid #22d3ee;
            border-radius: 50%;
            cursor: pointer;
            margin-top: -8px;
            transition: transform 0.2s ease;
        }
        
        input[type=range]:hover::-webkit-slider-thumb {
            transform: scale(1.1);
        }
        
        input[type=range]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #ffffff;
            border: 2px solid #22d3ee;
            border-radius: 50%;
            cursor: pointer;
        }
        
        /* Fix for main container */
        #app-section {
            min-height: 100vh;
            display: block;
        }
        
        /* Ensure content is visible */
        .debug-visible {
            opacity: 1 !important;
            transform: scale(1) !important;
            display: block !important;
            pointer-events: all !important;
        }
        
        /* Fix for sticky elements */
        .sticky {
            position: -webkit-sticky;
            position: sticky;
        }
    </style>
</head>
<body class="min-h-screen text-slate-800">

    <!-- Debug message -->
    <div id="debug-message" class="fixed top-0 left-0 right-0 bg-red-100 text-red-800 p-2 text-center z-50">
        Debug: Page loaded successfully. If you don't see content, check console for errors.
    </div>

    <div id="app-section" class="smooth-transition section-visible">
        <header class="bg-white/80 shadow-sm border-b backdrop-blur-lg sticky top-0 z-10">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex justify-between items-center py-4">
                    <div class="flex items-center space-x-3">
                         <svg class="h-8 w-8 text-cyan-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                             <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
                        </svg>
                        <h1 class="text-2xl font-bold text-slate-800">Marine Ecosystem Health Predictor</h1>
                    </div>
                    <div class="flex items-center space-x-4">
                        <span id="user-info" class="text-slate-600 hidden sm:block">Guest User</span>
                        <button id="logout-btn" 
                                class="bg-slate-200 text-slate-700 px-4 py-2 rounded-lg hover:bg-slate-300 transition duration-300 font-semibold text-sm">
                            Logout
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-2xl shadow-xl p-8 space-y-6 sticky top-28">
                        <div class="text-left">
                            <h2 class="text-2xl font-bold text-slate-900">Prediction Controls</h2>
                            <p class="text-slate-500 mt-2">Adjust environmental factors to predict bleaching risk.</p>
                        </div>

                        <form id="prediction-form" class="space-y-8">
                            <div class="slider-group">
                                <label for="Turbidity" class="flex justify-between items-center text-md font-medium text-slate-700 mb-1">
                                    <span>Turbidity</span>
                                    <span id="Turbidity-value" class="font-bold text-cyan-600 bg-cyan-100 rounded-md px-2 py-1 text-sm">0.5</span>
                                </label>
                                <input type="range" id="Turbidity" name="Turbidity" min="0" max="5" step="0.1" value="0.5">
                                <div class="flex justify-between text-xs text-slate-400 mt-1">
                                    <span>0</span><span>5</span>
                                </div>
                            </div>
                            
                            <div class="slider-group">
                                <label for="Depth_m" class="flex justify-between items-center text-md font-medium text-slate-700 mb-1">
                                    <span>Depth (meters)</span>
                                    <span id="Depth_m-value" class="font-bold text-cyan-600 bg-cyan-100 rounded-md px-2 py-1 text-sm">10</span>
                                </label>
                                <input type="range" id="Depth_m" name="Depth_m" min="0" max="50" step="1" value="10">
                                <div class="flex justify-between text-xs text-slate-400 mt-1">
                                    <span>0m</span><span>50m</span>
                                </div>
                            </div>

                            <div class="slider-group">
                                <label for="Temperature_Maximum" class="flex justify-between items-center text-md font-medium text-slate-700 mb-1">
                                    <span>Max Temperature (°C)</span>
                                    <span id="Temperature_Maximum-value" class="font-bold text-cyan-600 bg-cyan-100 rounded-md px-2 py-1 text-sm">30.0</span>
                                </label>
                                <input type="range" id="Temperature_Maximum" name="Temperature_Maximum" min="20" max="40" step="0.1" value="30.0">
                                 <div class="flex justify-between text-xs text-slate-400 mt-1">
                                    <span>20°C</span><span>40°C</span>
                                </div>
                            </div>

                            <div class="slider-group">
                                <label for="SSTA_DHW" class="flex justify-between items-center text-md font-medium text-slate-700 mb-1">
                                    <span>Degree Heating Week (SSTA)</span>
                                    <span id="SSTA_DHW-value" class="font-bold text-cyan-600 bg-cyan-100 rounded-md px-2 py-1 text-sm">4.0</span>
                                </label>
                                <input type="range" id="SSTA_DHW" name="SSTA_DHW" min="0" max="20" step="0.1" value="4.0">
                                 <div class="flex justify-between text-xs text-slate-400 mt-1">
                                    <span>0</span><span>20</span>
                                </div>
                            </div>

                             <div class="slider-group">
                                <label for="TSA_DHW" class="flex justify-between items-center text-md font-medium text-slate-700 mb-1">
                                    <span>Degree Heating Week (TSA)</span>
                                    <span id="TSA_DHW-value" class="font-bold text-cyan-600 bg-cyan-100 rounded-md px-2 py-1 text-sm">1.0</span>
                                </label>
                                <input type="range" id="TSA_DHW" name="TSA_DHW" min="0" max="20" step="0.1" value="1.0">
                                 <div class="flex justify-between text-xs text-slate-400 mt-1">
                                    <span>0</span><span>20</span>
                                </div>
                            </div>

                            <button type="submit" id="predict-btn" class="w-full flex items-center justify-center bg-cyan-500 text-white font-bold py-3 px-4 rounded-lg hover:bg-cyan-600 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-cyan-500 transition-transform duration-300 transform hover:scale-105 text-lg">
                                 <span id="predict-btn-text">
                                     <svg class="inline-block w-5 h-5 mr-2 -mt-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M9.75 3.104v5.714a2.25 2.25 0 01-.659 1.591L5 14.5M9.75 3.104c-.251.037-.502.068-.75.097h-1.5c-.331 0-.65.051-.964.146a2.25 2.25 0 00-1.933 2.163v1.929c0 .484.108.954.305 1.385v5.04c0 .356.12.696.337.983l1.164 1.699a2.25 2.25 0 001.933 1.056h1.5c.331 0 .65-.051.964-.146a2.25 2.25 0 001.933-2.163v-1.929c0-.484-.108-.954-.305-1.385v-5.04c0-.356-.12-.696-.337-.983l-1.164-1.699A2.25 2.25 0 0012 5.097h-1.5c-.248-.029-.499-.06-.75-.097z" />
                                    </svg>
                                    Predict Risk
                                 </span>
                                 <span id="predict-btn-spinner" class="hidden">
                                     <svg class="animate-spin h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                         <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                         <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                     </svg>
                                 </span>
                            </button>
                        </form>
                    </div>
                </div>

                <div class="lg:col-span-3">
                    <div id="result-container" class="space-y-8 section-hidden smooth-transition">
                         <div id="result-card" class="bg-white rounded-2xl shadow-xl p-6 text-center">
                            <h2 id="result-text" class="text-3xl font-bold"></h2>
                            <p id="result-advice" class="mt-2 text-slate-600 max-w-xl mx-auto"></p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-white rounded-2xl shadow-xl p-6">
                                <h3 class="font-bold text-lg text-slate-800 mb-4 text-center">Current Risk Level</h3>
                                <div id="gauge-plot" class="mx-auto" style="max-width:400px; min-height: 250px;"></div>
                            </div>
                             <div class="bg-white rounded-2xl shadow-xl p-6">
                                <h3 class="font-bold text-lg text-slate-800 mb-4 text-center">Prediction History</h3>
                                <div id="history-plot" class="mx-auto" style="min-height: 250px;"></div>
                            </div>
                        </div>

                         <div class="bg-white rounded-2xl shadow-xl p-6">
                             <h3 class="font-bold text-lg text-slate-800 mb-4 text-center">3D Feature Analysis</h3>
                             <div id="scatter3d-plot" class="mx-auto" style="min-height: 400px;"></div>
                        </div>
                    </div>

                    <div id="error-container" class="text-center pt-4 hidden">
                        <div class="p-4 bg-red-100 text-red-700 rounded-lg">
                            <p><strong>Error:</strong> <span id="error-text"></span></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
    console.log("JS loaded");
    // --- DOM Elements ---
        const appSection = document.getElementById('app-section');
        const logoutBtn = document.getElementById('logout-btn');
        const userInfo = document.getElementById('user-info');
        const form = document.getElementById('prediction-form');
        const resultContainer = document.getElementById('result-container');
        const resultCard = document.getElementById('result-card');
        const resultText = document.getElementById('result-text');
        const resultAdvice = document.getElementById('result-advice');
        const errorContainer = document.getElementById('error-container');
        const errorText = document.getElementById('error-text');
        const predictBtn = document.getElementById('predict-btn');
        const predictBtnText = document.getElementById('predict-btn-text');
        const predictBtnSpinner = document.getElementById('predict-btn-spinner');
        const debugMessage = document.getElementById('debug-message');

        // --- State ---
        // No authentication required

        // --- Functions ---
        const handleLogout = () => {
            localStorage.clear();
            resultContainer.classList.add('section-hidden');
            location.reload();
        };

        const updateSliderValue = (slider) => {
            const valueDisplay = document.getElementById(`${slider.id}-value`);
            if (valueDisplay) {
                valueDisplay.textContent = slider.value;
            }
            // Update custom track background
            const min = parseFloat(slider.min);
            const max = parseFloat(slider.max);
            const val = parseFloat(slider.value);
            const percentage = ((val - min) / (max - min)) * 100;
            slider.style.setProperty('--value-percent', `${percentage}%`);
        };

        const showLoadingState = (isLoading) => {
            predictBtn.disabled = isLoading;
            if (isLoading) {
                predictBtnText.classList.add('hidden');
                predictBtnSpinner.classList.remove('hidden');
            } else {
                predictBtnText.classList.remove('hidden');
                predictBtnSpinner.classList.add('hidden');
            }
        };

        const handlePrediction = async (event) => {
            event.preventDefault();
            
            showLoadingState(true);
            errorContainer.classList.add('hidden');
            
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            Object.keys(data).forEach(key => data[key] = parseFloat(data[key]));

            try {
                // For demo purposes, we'll simulate a prediction
                await new Promise(resolve => setTimeout(resolve, 1000)); // Simulate API delay
                
                // Simple prediction logic for demo
                const riskLevel = data.Temperature_Maximum > 32 || data.SSTA_DHW > 8 ? 1 : 0;
                const result = { prediction: riskLevel };
                displayResult(result.prediction, data);
            } catch (error) {
                console.error('Fetch error:', error);
                errorText.textContent = 'Could not connect to the API.';
                errorContainer.classList.remove('hidden');
            } finally {
                showLoadingState(false);
            }
        };
        
        const getPredictionHistory = () => {
            try {
                return JSON.parse(localStorage.getItem('predictionHistory') || '[]');
            } catch (e) {
                console.error('Error reading history from localStorage:', e);
                return [];
            }
        };
        
        const savePredictionHistory = (entry) => {
            try {
                let history = getPredictionHistory();
                history.push(entry);
                if (history.length > 10) history.shift();
                localStorage.setItem('predictionHistory', JSON.stringify(history));
            } catch (e) {
                console.error('Error saving history to localStorage:', e);
            }
        };

        const displayResult = (prediction, inputData) => {
            const newEntry = { ...inputData, prediction, timestamp: new Date().toLocaleString() };
            savePredictionHistory(newEntry);
            
            resultContainer.classList.remove('section-hidden');
            resultContainer.classList.add('section-visible');

            if (prediction === 1) {
                resultCard.className = 'bg-red-100 text-red-800 rounded-2xl shadow-xl p-6 text-center';
                resultText.textContent = 'High Risk of Bleaching Event';
                resultAdvice.textContent = 'The environmental conditions are highly conducive to coral bleaching. Mitigation efforts may be required.';
            } else {
                resultCard.className = 'bg-green-100 text-green-800 rounded-2xl shadow-xl p-6 text-center';
                resultText.textContent = 'Low Risk of Bleaching Event';
                resultAdvice.textContent = 'Conditions appear stable, indicating no immediate bleaching threat.';
            }

            drawGauge(prediction);
            drawHistoryPlot();
            draw3DScatterPlot();
        };

        const plotlyLayoutOptions = {
            font: { family: 'Inter, sans-serif', color: '#334155' },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
        };

        const drawGauge = (prediction) => {
            try {
                const value = prediction === 1 ? 85 : 15;
                const color = prediction === 1 ? '#ef4444' : '#22c55e';
                Plotly.newPlot('gauge-plot', [{
                    type: 'indicator',
                    mode: 'gauge+number',
                    value: value,
                    title: { text: 'Bleaching Risk', font: { size: 16 } },
                    gauge: {
                        axis: { range: [0, 100], tickwidth: 1, tickcolor: '#94a3b8' },
                        bar: { color },
                        steps: [
                            { range: [0, 50], color: '#dcfce7' },
                            { range: [50, 100], color: '#fee2e2' }
                        ],
                    },
                    number: { suffix: '%', font: { color, size: 36 } }
                }], { ...plotlyLayoutOptions, margin: { t: 40, b: 10, l: 30, r: 30 }, height: 250 }, { displayModeBar: false, responsive: true });
            } catch (e) {
                console.error('Error drawing gauge:', e);
            }
        };

        const drawHistoryPlot = () => {
            try {
                const history = getPredictionHistory();
                if (history.length === 0) return;
                const x = history.map(h => h.timestamp);
                const y = history.map(h => h.prediction === 1 ? 85 : 15);
                const colors = history.map(h => h.prediction === 1 ? '#ef4444' : '#22c55e');
                Plotly.newPlot('history-plot', [{
                    x, y, type: 'bar', marker: { color: colors },
                    text: history.map(h => `Temp: ${h.Temperature_Maximum}°C<br>Depth: ${h.Depth_m}m`),
                    hoverinfo: 'text+y',
                }], {
                    ...plotlyLayoutOptions,
                    yaxis: { title: 'Risk (%)', range: [0, 100] },
                    xaxis: { showticklabels: false },
                    margin: { t: 20, b: 30, l: 40, r: 20 },
                    height: 250
                }, { displayModeBar: false, responsive: true });
            } catch (e) {
                console.error('Error drawing history plot:', e);
            }
        };

        const draw3DScatterPlot = () => {
            try {
                const history = getPredictionHistory();
                if (history.length === 0) return;
                const colors = history.map(h => h.prediction === 1 ? '#ef4444' : '#22c55e');
                Plotly.newPlot('scatter3d-plot', [{
                    x: history.map(h => h.Temperature_Maximum),
                    y: history.map(h => h.SSTA_DHW),
                    z: history.map(h => h.Depth_m),
                    mode: 'markers', type: 'scatter3d',
                    marker: { size: 8, color: colors, opacity: 0.8 },
                    text: history.map(h => `Risk: ${h.prediction === 1 ? 'High' : 'Low'}`),
                    hoverinfo: 'text+x+y+z',
                }], {
                    ...plotlyLayoutOptions,
                    title: 'Relationship Between Temp, Heat Stress & Depth',
                    scene: {
                        xaxis: { title: 'Max Temp (°C)' },
                        yaxis: { title: 'SSTA DHW' },
                        zaxis: { title: 'Depth (m)' }
                    },
                    margin: { t: 40, b: 40, l: 20, r: 20 },
                    height: 400
                }, { displayModeBar: true, responsive: true });
            } catch (e) {
                console.error('Error drawing 3D scatter plot:', e);
            }
        };

        // --- Event Listeners & Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM fully loaded and parsed');
            
            // Set user info
            userInfo.textContent = 'Guest User';
            
            // Initialize the logout button
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            } else {
                console.error('Logout button not found');
            }
            
            // Initialize the prediction form
            if (form) {
                form.addEventListener('submit', handlePrediction);
            } else {
                console.error('Prediction form not found');
            }
            
            // Initialize sliders
            const sliders = document.querySelectorAll('input[type=range]');
            if (sliders.length > 0) {
                sliders.forEach(slider => {
                    slider.addEventListener('input', () => updateSliderValue(slider));
                    updateSliderValue(slider); // Initial update on load
                });
            } else {
                console.error('No sliders found');
            }
            
            // Load any existing prediction history
            const history = getPredictionHistory();
            if (history.length > 0) {
                const lastEntry = history[history.length - 1];
                displayResult(lastEntry.prediction, lastEntry);
            }
            
            // Hide debug message after 3 seconds
            setTimeout(() => {
                if (debugMessage) {
                    debugMessage.classList.add('hidden');
                }
            }, 3000);
        });

        // Global error handler
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            if (debugMessage) {
                debugMessage.textContent = 'Error: ' + e.error.message;
                debugMessage.classList.remove('hidden');
            }
        });
    </script>
</body>
</html>